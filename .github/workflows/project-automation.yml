name: Project Automation

on:
  issues:
    types: [opened, labeled, assigned, closed]
  pull_request:
    types: [opened, ready_for_review, review_requested, closed]
  pull_request_review:
    types: [submitted]

jobs:
  add-to-project:
    name: Add issue/PR to project
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Add to project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/YOUR_USERNAME/projects/YOUR_PROJECT_NUMBER
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}

  auto-assign-labels:
    name: Auto-assign labels
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Check if critical priority
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';

            // ì´ìŠˆ ë³¸ë¬¸ì—ì„œ ìš°ì„ ìˆœìœ„ í™•ì¸
            if (body.includes('Critical') || body.includes('ì¦‰ì‹œ í•„ìš”')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['priority:critical']
              });
            }

  notify-fe-team:
    name: Notify FE team for dependencies
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      (github.event.action == 'opened' || github.event.action == 'labeled') &&
      contains(github.event.issue.body, 'Blocks FE')
    steps:
      - name: Create comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const comment = `
            ğŸ”” **í”„ë¡ íŠ¸ì—”ë“œ íŒ€ ì•Œë¦¼**

            ì´ ë°±ì—”ë“œ ì‘ì—…ì´ ì™„ë£Œë˜ì–´ì•¼ í”„ë¡ íŠ¸ì—”ë“œ ì‘ì—…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            - ë‹´ë‹¹ì: ${issue.assignee ? '@' + issue.assignee.login : 'ë¯¸ì •'}
            - ìš°ì„ ìˆœìœ„: ${issue.labels.find(l => l.name.startsWith('priority:'))?.name || 'ë¯¸ì •'}

            í”„ë¡ íŠ¸ì—”ë“œ ë ˆí¬ì§€í† ë¦¬ì— ê´€ë ¨ ì´ìŠˆë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: comment
            });

  pr-auto-label:
    name: Auto-label PR based on files changed
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto-label based on files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const labels = new Set();

            for (const file of files) {
              const path = file.filename;

              // íŒŒì¼ ê²½ë¡œì— ë”°ë¼ ë¼ë²¨ ì¶”ê°€
              if (path.includes('alembic/') || path.includes('models/')) {
                labels.add('area:database');
              }
              if (path.includes('api/')) {
                labels.add('area:api');
              }
              if (path.includes('services/')) {
                labels.add('area:service');
              }
              if (path.includes('test') || path.includes('spec')) {
                labels.add('type:test');
              }
              if (path.includes('.md') || path.includes('docs/')) {
                labels.add('type:docs');
              }
            }

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: Array.from(labels)
              });
            }

  check-migrations:
    name: Check if migration is needed
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for model changes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const hasModelChanges = files.some(file =>
              file.filename.includes('app/models/') &&
              !file.filename.includes('__init__.py')
            );

            const hasMigration = files.some(file =>
              file.filename.includes('alembic/versions/')
            );

            if (hasModelChanges && !hasMigration) {
              const comment = `
              âš ï¸ **ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´í¬**

              ëª¨ë¸ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì§€ë§Œ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

              ë§ˆì´ê·¸ë ˆì´ì…˜ì´ í•„ìš”í•œ ê²½ìš°:
              \`\`\`bash
              just revision "description of changes"
              \`\`\`

              ë§ˆì´ê·¸ë ˆì´ì…˜ì´ í•„ìš”í•˜ì§€ ì•Šì€ ê²½ìš° ì´ ì½”ë©˜íŠ¸ë¥¼ ë¬´ì‹œí•˜ì„¸ìš”.
              `;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }

  update-issue-on-pr-merge:
    name: Update linked issues when PR is merged
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Add completion comment to linked issues
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';

            // PR ë³¸ë¬¸ì—ì„œ Closes #123 í˜•íƒœì˜ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
            const issueRefs = prBody.match(/(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#(\d+)/gi);

            if (issueRefs) {
              for (const ref of issueRefs) {
                const issueNumber = ref.match(/#(\d+)/)[1];

                const comment = `
                âœ… **ì™„ë£Œë¨**

                ì´ ì´ìŠˆëŠ” PR #${pr.number}ì—ì„œ í•´ê²°ë˜ì–´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.

                - ë¨¸ì§€ë¨: ${new Date().toISOString()}
                - ë¨¸ì§€í•œ ì‚¬ëŒ: @${pr.merged_by.login}
                `;

                try {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: parseInt(issueNumber),
                    body: comment
                  });
                } catch (error) {
                  console.log(`Failed to comment on issue #${issueNumber}: ${error.message}`);
                }
              }
            }

  pr-review-notification:
    name: Notify on PR review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_review'
    steps:
      - name: Notify on changes requested
        uses: actions/github-script@v7
        if: github.event.review.state == 'changes_requested'
        with:
          script: |
            const comment = `
            ğŸ”„ **ë³€ê²½ ìš”ì²­ë¨**

            @${context.payload.pull_request.user.login} ë¦¬ë·°ì–´ê°€ ë³€ê²½ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.

            ë¦¬ë·° ì½”ë©˜íŠ¸ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
